<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Bootstrap CSS -->
    <style>
        .invalid-feedback {
            display: none;
            color: red;
        }

        .is-invalid {
            border: 1px solid red;
        }

        .verification-timer {
            color: red;
        }
    </style>
</head>

<th:block layout:fragment="content">
    <body class="bg-light">
    <div class="container">
        <div class="row justify-content-center mt-5">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title text-center mb-4">회원가입</h3>
                        <form id="signupForm">
                            <!-- 아이디 입력란 -->
                            <div class="form-group">
                                <label for="userId">아이디:</label>
                                <input type="text" class="form-control" id="userId" name="userId" required minlength="5" maxlength="20">
                                <div class="invalid-feedback" id="userIdValidation">5~20자의 영문 소문자, 숫자와 특수기호(_),(-)만 사용 가능합니다.</div>
                            </div>
                            <!-- 비밀번호 입력란 -->
                            <div class="form-group">
                                <label for="password">비밀번호:</label>
                                <input type="password" class="form-control" id="password" name="password" required minlength="8" maxlength="16">
                                <div class="invalid-feedback" id="passwordValidation">8~16자의 영문과 숫자를 사용해 주세요.</div>
                            </div>
                            <div class="form-group">
                                <label for="userName">이름:</label>
                                <input type="text" class="form-control" id="userName" name="userName" required>
                            </div>
                            <div class="form-group">
                                <label for="birthdate">생년월일:</label>
                                <input type="text" class="form-control" id="birthdate" name="birthdate" required pattern="[0-9]{8}" placeholder="YYYYMMDD">
                            </div>
                            <!-- 성별 선택 -->
                            <div class="form-group">
                                <label for="gender">성별:</label>
                                <select id="gender" name="gender" required>
                                    <option value="">성별 선택</option>
                                    <option value="MALE">남성</option>
                                    <option value="FEMALE">여성</option>
                                </select>
                            </div>
                            <!-- 인증 방법 선택 -->
                            <div class="form-group">
                                <label for="verificationMethod">인증 방법 선택:</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="verificationMethod" id="phoneVerification" value="phone">
                                        <label class="form-check-label" for="phoneVerification">휴대폰 인증</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="verificationMethod" id="emailVerification" value="email">
                                        <label class="form-check-label" for="emailVerification">이메일 인증</label>
                                    </div>
                                </div>
                            </div>

                            <!-- 휴대폰 번호 입력란 -->
                            <div class="form-group" id="phoneInput" style="display: none;">
                                <div class="form-group">
                                    <label for="telecom">통신사 선택:</label>
                                    <select id="telecom" name="telecom" class="form-control" required>
                                        <option value="">통신사 선택</option>
                                        <option value="SKT">SKT</option>
                                        <option value="KT">KT</option>
                                        <option value="LGU+">LG U+</option>
                                        <option value="SKT알뜰폰">SKT 알뜰폰</option>
                                        <option value="KT알뜰폰">KT 알뜰폰</option>
                                        <option value="LGU+알뜰폰">LG U+ 알뜰폰</option>
                                    </select>
                                </div>
                                <label for="phone">전화번호:</label>
                                <div class="input-group">
                                    <input type="tel" class="form-control" id="phone" name="phone">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary" type="button" id="phoneVerificationButton">휴대폰 인증</button>
                                    </div>
                                </div>
                                <input type="text" class="form-control mt-2" id="phoneVerificationCode" name="phoneVerificationCode" placeholder="휴대폰 인증 코드">
                                <button type="button" class="btn btn-primary mt-2" id="phoneConfirmButton" disabled>인증 확인</button>
                                <span class="verification-timer ml-2" id="phoneVerificationTimer"  style="display:none">남은 시간: 10:00</span>
                            </div>
                            <!-- 이메일 입력란 -->
                            <div class="form-group" id="emailInput" style="display: none;">
                                <label for="email">이메일:</label>
                                <div class="input-group">
                                    <input type="email" class="form-control" id="email" name="email" required minlength="5" maxlength="255">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary" type="button" id="emailVerificationButton">이메일 인증</button>
                                    </div>
                                </div>
                                <input type="text" class="form-control mt-2" id="emailVerificationCode" name="emailVerificationCode" placeholder="이메일 인증 코드">
                                <button type="button" class="btn btn-primary mt-2" id="emailConfirmButton" disabled>인증 확인</button>
                                <span class="verification-timer ml-2" id="emailVerificationTimer" style="display:none">남은 시간: 10:00</span>
                            </div>
                            <button type="button" class="btn btn-primary btn-block" onclick="signup()">회원가입 요청하기</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>


<script>

        // 선택한 인증 방법에 따라 해당 입력 칸을 표시하거나 감추는 함수
        document.querySelectorAll('input[type="radio"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                var verificationMethod = this.value;
                if (verificationMethod === 'phone') {
                    document.getElementById('phoneInput').style.display = 'block';
                    document.getElementById('emailInput').style.display = 'none';
                } else if (verificationMethod === 'email') {
                    document.getElementById('phoneInput').style.display = 'none';
                    document.getElementById('emailInput').style.display = 'block';
                }
            });
        });



        // 회원가입 폼 유효성 검사
        function validateSignupForm() {
            var userId = document.getElementById('userId');
            var password = document.getElementById('password');
            var userIdValidation = document.getElementById('userIdValidation');
            var passwordValidation = document.getElementById('passwordValidation');
            // 아이디 유효성 검사
            if (!userId.checkValidity()) {
                userId.classList.add('is-invalid');
                userIdValidation.style.display = 'block';
            } else {
                userId.classList.remove('is-invalid');
                userIdValidation.style.display = 'none';
            }

            // 비밀번호 유효성 검사
            if (!password.checkValidity()) {
                password.classList.add('is-invalid');
                passwordValidation.style.display = 'block';
            } else {
                password.classList.remove('is-invalid');
                passwordValidation.style.display = 'none';
            }

            // 유효성 검사 통과 여부 반환
            return userId.checkValidity() && password.checkValidity();
        }

        // 회원가입 요청 함수
        function signup() {
            var isValid = validateSignupForm();
            if (!isValid) {
                return; // 유효성 검사 실패 시 요청 중지
            }

            var form = document.getElementById("signupForm");
            var formData = new FormData(form);

            fetch('/api/user/signup', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('서버 응답 오류');
                }
                return response.json();
            })
            .then(data => {
                console.log(data);
                alert('회원가입이 성공적으로 완료되었습니다.');
                window.location.href = "/";
            })
            .catch(error => {
                alert('오류가 발생했습니다: ' + error.message);
                console.error('오류:', error);
            });
        }


var phoneIntervalId; // 휴대폰 타이머 ID
var emailIntervalId; // 이메일 타이머 ID

// 타이머 함수
function startVerificationTimer(duration, display, isPhone) {
    var timer = duration, minutes, seconds;
    if(isPhone){
        clearInterval(phoneIntervalId);
    }else{
        clearInterval(emailIntervalId);
    }
    function updateTimer() {
        minutes = parseInt(timer / 60, 10);
        seconds = parseInt(timer % 60, 10);

        minutes = minutes < 10 ? "0" + minutes : minutes;
        seconds = seconds < 10 ? "0" + seconds : seconds;

        display.textContent = "남은 시간: " + minutes + ":" + seconds;

        if (--timer < 0) {
            clearInterval(isPhone ? phoneIntervalId : emailIntervalId);
            display.textContent = "시간 만료";
            if (isPhone) {
                document.getElementById('phoneVerificationButton').textContent = '휴대폰 인증';
            } else {
                document.getElementById('emailVerificationButton').textContent = '이메일 인증';
            }
        }
    }

    // 최초 실행
    updateTimer();

    // 1초마다 updateTimer 함수 호출
    var intervalId = setInterval(updateTimer, 1000);

    // 휴대폰 타이머 ID 또는 이메일 타이머 ID 설정
    if (isPhone) {
        phoneIntervalId = intervalId;
    } else {
        emailIntervalId = intervalId;
    }
}
// 버튼 클릭 시 이벤트 처리
// 이메일 인증
document.getElementById('emailVerificationButton').addEventListener('click', function() {
    // emailConfirmButton 활성화
    document.getElementById('emailConfirmButton').removeAttribute('disabled');
    document.getElementById('emailVerificationTimer').style.display = 'block';
    clearInterval(emailIntervalId);
    startVerificationTimer(600, document.getElementById('emailVerificationTimer'), false);
});
// 휴대폰 인증
document.getElementById('phoneVerificationButton').addEventListener('click', function() {
    document.getElementById('phoneConfirmButton').removeAttribute('disabled');
    document.getElementById('phoneVerificationTimer').style.display = 'block';
    clearInterval(phoneIntervalId);    // 기존 타이머 초기화
    startVerificationTimer(600, document.getElementById('phoneVerificationTimer'), true);
});

</script>
</body>
</th:block>
</html>